# OffWeGo CI/CD Pipeline
# This workflow handles continuous integration and deployment for both Frontend and Backend

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  NODE_VERSION: '20'
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: navyacs/offwego

jobs:
  # ============================================
  # Backend CI Jobs
  # ============================================
  backend-lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Backend/package-lock.json

      - name: Install dependencies
        working-directory: ./Backend
        run: npm ci

      - name: Run ESLint
        working-directory: ./Backend
        run: npm run lint

  backend-build:
    name: Backend Build
    runs-on: ubuntu-latest
    needs: backend-lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Backend/package-lock.json

      - name: Install dependencies
        working-directory: ./Backend
        run: npm ci

      - name: Build TypeScript
        working-directory: ./Backend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: Backend/dist
          retention-days: 7

  # ============================================
  # Frontend CI Jobs
  # ============================================
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./Frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./Frontend
        run: npm run lint

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: frontend-lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./Frontend
        run: npm ci

      - name: Build Frontend
        working-directory: ./Frontend
        env:
          VITE_BASE_URL: ${{ secrets.VITE_BASE_URL || '/' }}
          VITE_SOCKET_URL: ${{ secrets.VITE_SOCKET_URL || '/' }}
          VITE_CLOUDINARY_CLOUD_NAME: ${{ secrets.VITE_CLOUDINARY_CLOUD_NAME }}
          VITE_CLOUDINARY_UPLOAD_PRESET: ${{ secrets.VITE_CLOUDINARY_UPLOAD_PRESET }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
          VITE_OPENCAGE_API_KEY: ${{ secrets.VITE_OPENCAGE_API_KEY }}
          VITE_IMAGE_URL: ${{ secrets.VITE_IMAGE_URL || '/' }}
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: Frontend/dist
          retention-days: 7

  # ============================================
  # Docker Build Job - Unified Image
  # ============================================
  docker-build-unified:
    name: Build Unified Docker Image
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push unified image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_BASE_URL=${{ secrets.VITE_BASE_URL || (format('https://{0}/', secrets.PRODUCTION_DOMAIN) != 'https:///' && format('https://{0}/', secrets.PRODUCTION_DOMAIN) || '/') }}
            VITE_SOCKET_URL=${{ secrets.VITE_SOCKET_URL || (format('https://{0}/', secrets.PRODUCTION_DOMAIN) != 'https:///' && format('https://{0}/', secrets.PRODUCTION_DOMAIN) || '/') }}
            VITE_CLOUDINARY_CLOUD_NAME=${{ secrets.VITE_CLOUDINARY_CLOUD_NAME }}
            VITE_CLOUDINARY_UPLOAD_PRESET=${{ secrets.VITE_CLOUDINARY_UPLOAD_PRESET }}
            VITE_STRIPE_PUBLISHABLE_KEY=${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
            VITE_OPENCAGE_API_KEY=${{ secrets.VITE_OPENCAGE_API_KEY }}
            VITE_IMAGE_URL=${{ secrets.VITE_IMAGE_URL || '/' }}
            VITE_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Deploy Job (Optional - Configure as needed)
  # ============================================
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    needs: docker-build-unified
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy config files to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: 22
          source: "nginx/nginx.conf.template,docker-compose.prod.yml"
          target: "~/offwego"

      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@v1.0.0
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          JWT_ACCESSTOKENSECRETKEY: ${{ secrets.JWT_ACCESSTOKENSECRETKEY }}
          JWT_REFRESHTOKEN: ${{ secrets.JWT_REFRESHTOKEN }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          DOMAIN_URL: ${{ secrets.DOMAIN_URL }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          NODEMAILER_EMAIL: ${{ secrets.NODEMAILER_EMAIL }}
          NODEMAILER_PASSWORD: ${{ secrets.NODEMAILER_PASSWORD }}
          PROD_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.AWS_EC2_SSH_KEY }}
          port: 22
          envs: >-
            MONGO_URI,REDIS_PASSWORD,JWT_ACCESSTOKENSECRETKEY,JWT_REFRESHTOKEN,STRIPE_SECRET_KEY,
            CLOUDINARY_CLOUD_NAME,CLOUDINARY_API_KEY,CLOUDINARY_API_SECRET,
            DOMAIN_URL,FIREBASE_SERVICE_ACCOUNT,GOOGLE_CLIENT_ID,NODEMAILER_EMAIL,NODEMAILER_PASSWORD,PROD_DOMAIN
          script: |
            mkdir -p ~/offwego/nginx
            cd ~/offwego
            
            # Construct .env file from individual environment variables
            cat <<EOF > .env
            PORT=1212
            NODE_ENV=production
            FRONTEND_URL="https://offwego.online"
            MONGO_URI="$MONGO_URI"
            REDIS_HOST=redis
            REDIS_PORT=6379
            REDIS_PASSWORD="$REDIS_PASSWORD"
            JWT_ACCESSTOKENSECRETKEY="$JWT_ACCESSTOKENSECRETKEY"
            JWT_REFRESHTOKEN="$JWT_REFRESHTOKEN"
            STRIPE_SECRET_KEY="$STRIPE_SECRET_KEY"
            CLOUDINARY_CLOUD_NAME="$CLOUDINARY_CLOUD_NAME"
            CLOUDINARY_API_KEY="$CLOUDINARY_API_KEY"
            CLOUDINARY_API_SECRET="$CLOUDINARY_API_SECRET"
            DOMAIN_URL="$DOMAIN_URL"
            FIREBASE_SERVICE_ACCOUNT='$FIREBASE_SERVICE_ACCOUNT'
            GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID"
            NODEMAILER_EMAIL="$NODEMAILER_EMAIL"
            NODEMAILER_PASSWORD="$NODEMAILER_PASSWORD"
            EOF
            
            echo "âœ… .env file generated."
            
            DOMAIN="${PROD_DOMAIN:-localhost}"
            
            # Prepare Nginx config from template
            cp nginx/nginx.conf.template nginx/nginx.conf
            sed -i "s/REPLACE_WITH_DOMAIN/$DOMAIN/g" nginx/nginx.conf

            # Log in and update services
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
            sudo docker compose -f docker-compose.prod.yml pull
            sudo docker compose -f docker-compose.prod.yml up -d
            
            # Initial SSL generation if certificate doesn't exist
            if [ "$DOMAIN" != "localhost" ] && [ ! -d "certbot/conf/live/$DOMAIN" ]; then
                echo "ðŸš€ Requesting initial SSL certificates..."
                sudo docker compose -f docker-compose.prod.yml stop nginx
                sudo docker compose -f docker-compose.prod.yml run --rm -p 80:80 --entrypoint certbot certbot certonly --standalone --non-interactive --preferred-challenges http --email navyaaaa303@gmail.com --agree-tos --no-eff-email -d $DOMAIN
                sudo docker compose -f docker-compose.prod.yml up -d nginx
            fi

            sudo docker logs offwego-prod --tail 50

      # Option 2: Deploy to AWS ECS
      # Note: Requires a task-definition.json file in the root
      # - name: Deploy to AWS ECS
      #   uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      #   with:
      #     task-definition: task-definition.json
      #     service: offwego-service
      #     cluster: offwego-cluster

      # Option 3: Deploy to DigitalOcean App Platform (Disabled)
      # - name: Deploy to DigitalOcean
      #   uses: digitalocean/app_action@v1.1.6
      #   with:
      #     app_name: offwego
      #     token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      # Option 4: Deploy to Railway (Disabled)
      # - name: Deploy to Railway
      #   uses: bervProject/railway-deploy@main
      #   with:
      #     railway_token: ${{ secrets.RAILWAY_TOKEN }}
      #     service: offwego

      - name: Deployment complete
        run: echo "âœ… Deployment pipeline completed successfully!"

  # ============================================
  # Cleanup Job
  # ============================================
  cleanup:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build]
    if: always()
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10
